MODx.tree.Directory=function(A){A=A||{};Ext.applyIf(A,{rootVisible:false,root_id:"root",root_name:_("files"),title:_("files"),enableDrag:false,enableDrop:false,ddAppendOnly:true,url:MODx.config.connectors_url+"browser/directory.php",action:"getList",primaryKey:"dir"});MODx.tree.Directory.superclass.constructor.call(this,A);this.treeEditor=new Ext.tree.TreeEditor(this,new Ext.form.Field({cancelOnEsc:true,completeOnEnter:true,ignoreNoChange:true,allowBlank:false,stateEvents:[{change:{scope:this,fn:this.renameNode}}]}));this.treeEditor.on("beforestartedit",function(){if(!this.treeEditor.editNode.attributes.allowEdit===false){return false}},this)};Ext.extend(MODx.tree.Directory,MODx.tree.Tree,{windows:{},_showContextMenu:function(C,D){C.select();this.cm.activeNode=C;var A=this.cm;var B=C.id.split("_");A.removeAll();if(C.attributes.menu){this.addContextMenuItem(C.attributes.menu)}this.uploader=new Ext.ux.UploadPanel({contextmenu:this.cm,buttonsAt:"tbar",singleUpload:false,enableProgress:true,baseParams:{action:"upload"}});this.uploader.on({beforeupload:{scope:this,fn:this.onBeforeUpload},allfinished:{scope:this,fn:this.onAllFinished}});this.uploader.setUrl(MODx.config.connectors_url+"browser/file.php");A.add("-");A.add(new Ext.menu.Adapter(this.uploader,{hideOnClick:false,cmd:"upload-panel"}));A.show(C.ui.getEl(),"t?");A.activeNode=C},onAllFinished:function(){var A=this.cm.activeNode;(A.isLeaf()?A.parentNode:A).reload()},onBeforeUpload:function(C){var A=this.cm.activeNode;var B=this.getPath(A);if(A.isLeaf()){B=B.replace(/\/[^\/]+$/,"",B)}this.uploader.setPath(B)},getPath:function(B){var D,C,A;if(B!==this.root){C=B.parentNode;A=[B.text];while(C&&C!==this.root){A.unshift(C.text);C=C.parentNode}A.unshift(this.root.attributes.path||"");D=A.join(this.pathSeparator)}else{D=B.attributes.path||""}D=D.replace(/^[\/\.]*/,"");return D+"/"},renameNode:function(C,A,B){Ext.Ajax.request({url:MODx.config.connectors_url+"browser/index.php",params:{action:"rename",new_name:A,old_name:B,file:this.treeEditor.editNode.id},scope:this,success:function(D){D=Ext.decode(D.responseText);if(D.success){this.refresh()}else{MODx.form.Handler.errorJSON(D)}}})},createDirectory:function(C,D){var B=this.cm.activeNode;var A={parent:B.id};if(!this.windows.create){this.windows.create=new MODx.window.CreateDirectory({record:A,scope:this,success:this.refresh})}else{this.windows.create.setValues(A)}this.windows.create.show(D.target)},chmodDirectory:function(C,D){var B=this.cm.activeNode;var A={dir:B.id};if(!this.windows.chmod){this.windows.chmod=new MODx.window.ChmodDirectory({record:A,scope:this,success:this.refresh})}else{this.windows.chmod.setValues(A)}this.windows.chmod.show(D.target)},removeFile:function(B,C){var A=this.cm.activeNode;MODx.msg.confirm({text:_("file_confirm_remove"),connector:MODx.config.connectors_url+"browser/file.php",params:{action:"remove",file:A.id},scope:this,success:this.refreshParentNode})}});Ext.reg("tree-directory",MODx.tree.Directory);MODx.window.CreateDirectory=function(A){A=A||{};Ext.applyIf(A,{width:430,height:200,title:_("file_folder_create"),connector:MODx.config.connectors_url+"browser/directory.php",action:"create",fields:[{fieldLabel:_("name"),name:"name",xtype:"textfield",width:150,allowBlank:false},{fieldLabel:_("file_folder_parent"),name:"parent",xtype:"textfield",width:200}]});MODx.window.CreateDirectory.superclass.constructor.call(this,A)};Ext.extend(MODx.window.CreateDirectory,MODx.Window);Ext.reg("window-directory-create",MODx.window.CreateDirectory);MODx.window.ChmodDirectory=function(A){A=A||{};Ext.applyIf(A,{title:_("file_folder_chmod"),width:430,height:200,connector:MODx.config.connectors_url+"browser/directory.php",action:"chmod",fields:[{fieldLabel:_("mode"),name:"mode",xtype:"textfield",width:150,allowBlank:false},{name:"dir",xtype:"hidden",width:200}]});MODx.window.ChmodDirectory.superclass.constructor.call(this,A)};Ext.extend(MODx.window.ChmodDirectory,MODx.Window);Ext.reg("window-directory-chmod",MODx.window.ChmodDirectory);