Ext.namespace("MODx.grid");MODx.grid.Grid=function(A){A=A||{};this.config=A;this._loadStore();this._loadColumnModel();this._loadMenu();Ext.applyIf(A,{store:this.store,cm:this.cm,sm:new Ext.grid.RowSelectionModel({singleSelect:true}),paging:(A.bbar?true:false),loadMask:true,autoHeight:true,collapsible:true,stripeRows:true,viewConfig:{forceFit:true,enableRowBody:true,autoFill:true,showPreview:true},tools:[{id:"help",qtip:_("help"),handler:this.help,scope:this}],listeners:{rowcontextmenu:{fn:this._showMenu,scope:this}}});if(A.paging){Ext.applyIf(A,{bbar:new Ext.PagingToolbar({pageSize:20,store:this.getStore(),displayInfo:true,items:A.pagingItems||[]})})}if(A.grouping){Ext.applyIf(A,{view:new Ext.grid.GroupingView({forceFit:true,groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "'+(A.pluralText||_("records"))+'" : "'+(A.singleText||_("record"))+'"]})'})})}if(A.tbar){for(var B=0;B<A.tbar.length;B++){var C=A.tbar[B];if(C.handler&&typeof (C.handler)=="object"&&C.handler.xtype){C.handler=this.loadWindow.createDelegate(this,[C.handler],true)}if(!C.scope){C.scope=this}}}MODx.grid.Grid.superclass.constructor.call(this,A);if(!A.preventRender){this.render()}if(A.autosave){this.on("afteredit",this.saveRecord,this)}if(A.paging&&A.grouping){this.getBottomToolbar().bind(this.store)}this.getStore().load({params:{start:0,limit:20},scope:this,callback:function(){this.getStore().reload()}});this.config=A};Ext.extend(MODx.grid.Grid,Ext.grid.EditorGridPanel,{windows:{},saveRecord:function(C){C.record.data.menu=null;var B=this.config.saveParams||{};Ext.apply(C.record.data,B);var D=Ext.util.JSON.encode(C.record.data);var A=this.config.saveUrl||(this.config.url||this.config.connector);Ext.Ajax.request({url:A,params:{action:this.config.save_action||"updateFromGrid",data:D},scope:this,callback:function(G,E,F){F=Ext.decode(F.responseText);if(F.success){if(this.config.save_callback){Ext.callback(this.config.save_callback,this.config.scope||this,[F])}C.record.commit();this.refresh()}else{MODx.form.Handler.errorJSON(F)}}})},loadWindow:function(A,E,D,C){var B=this.menu.record;if(!this.windows[D.xtype]){Ext.applyIf(D,{scope:this,success:this.refresh,record:D.blankValues?{}:B,grid:this});if(C){Ext.apply(D,C)}this.windows[D.xtype]=Ext.ComponentMgr.create(D)}if(this.windows[D.xtype].setValues&&D.blankValues!==true){this.windows[D.xtype].setValues(B)}this.windows[D.xtype].show(E.target)},confirm:function(B,D){var C={action:B};var A=this.config.primaryKey||"id";C[A]=this.menu.record[A];MODx.msg.confirm({title:_(B),text:_(D)||_("confirm_remove"),connector:this.config.url,params:C,scope:this,success:this.refresh})},remove:function(D){var B=this.menu.record;D=D||"confirm_remove";var C=this.config.saveParams||{};Ext.apply(C,{action:"remove"});var A=this.config.primaryKey||"id";C[A]=B[A];MODx.msg.confirm({title:_("warning"),text:_(D),connector:this.config.url,params:C,scope:this,success:this.removeActiveRow})},removeActiveRow:function(){var A=this.getSelectionModel().getSelected();this.getStore().remove(A)},_loadMenu:function(){this.menu=new Ext.menu.Menu({defaultAlign:"tl-b?"})},_showMenu:function(B,A,C){C.stopEvent();C.preventDefault();this.menu.record=this.getStore().getAt(A).data;if(!this.getSelectionModel().isSelected(A)){this.getSelectionModel().selectRow(A)}this.menu.removeAll();if(this.menu.record.menu){this.addContextMenuItem(this.menu.record.menu);this.menu.show(C.target)}},_loadStore:function(){if(this.config.grouping){this.store=new Ext.data.GroupingStore({url:this.config.url,baseParams:this.config.baseParams||{action:this.config.action||"getList"},reader:new Ext.data.JsonReader({totalProperty:"total",root:"results",fields:this.config.fields}),sortInfo:{field:this.config.sortBy||"name",direction:this.config.sortDir||"ASC"},groupField:this.config.groupBy||"name"})}else{this.store=new Ext.data.JsonStore({url:this.config.url,baseParams:this.config.baseParams||{action:this.config.action||"getList"},fields:this.config.fields,root:"results",totalProperty:"total",remoteSort:this.config.remoteSort||false})}},_loadColumnModel:function(){if(this.config.columns){var c=this.config.columns;for(var i=0;i<c.length;i++){if(typeof (c[i].editor)=="string"){c[i].editor=eval(c[i].editor)}if(typeof (c[i].renderer)=="string"){c[i].renderer=eval(c[i].renderer)}if(typeof (c[i].editor)=="object"&&c[i].editor.xtype){var r=c[i].editor.renderer;c[i].editor=Ext.ComponentMgr.create(c[i].editor);if(r===true){c[i].renderer=MODx.combo.Renderer(c[i].editor)}else{if(c[i].editor.initialConfig.xtype==="datefield"){c[i].renderer=Ext.util.Format.dateRenderer(c[i].editor.initialConfig.format||"Y-m-d")}else{if(r==="boolean"){c[i].renderer=this.rendYesNo}else{if(r==="local"&&typeof (c[i].renderer)=="string"){c[i].renderer=eval(c[i].renderer)}}}}}}this.cm=new Ext.grid.ColumnModel(c)}},addContextMenuItem:function(items){var a=items,l=a.length;for(var i=0;i<l;i++){var options=a[i];if(options=="-"){this.menu.add("-");continue}if(options.handler){var h=eval(options.handler);if(h&&typeof (h)=="object"&&h.xtype){h=this.loadWindow.createDelegate(this,[h],true)}}else{var h=function(itm,e){var o=itm.options;var id=this.menu.record.id;var w=Ext.get("modx_content");if(o.confirm){Ext.Msg.confirm("",o.confirm,function(e){if(e=="yes"){var a=Ext.urlEncode(o.params||{action:o.action});var s="index.php?id="+id+"&"+a;if(w==null){location.href=s}else{w.dom.src=s}}},this)}else{var a=Ext.urlEncode(o.params||{action:o.action});var s="index.php?id="+id+"&"+a;if(w==null){location.href=s}else{w.dom.src=s}}}}this.menu.add({id:options.id||Ext.id(),text:options.text,scope:this,options:options,handler:h})}},refresh:function(){this.getStore().reload()},help:function(){Ext.Msg.alert(_("help"),_("help_not_yet"))},rendYesNo:function(A,B){switch(A){case"":return"-";case false:B.css="red";return _("no");case true:B.css="green";return _("yes")}},editorYesNo:function(A){A=A||{};Ext.applyIf(A,{store:new Ext.data.SimpleStore({fields:["d","v"],data:[[_("yes"),true],[_("no"),false]]}),displayField:"d",valueField:"v",mode:"local",triggerAction:"all",editable:false,selectOnFocus:false});return new Ext.form.ComboBox(A)},encodeModified:function(){var C=this.getStore().getModifiedRecords();var A={};for(var B=0;B<C.length;B++){A[C[B].data.id]=C[B].data}return Ext.encode(A)}});Ext.grid.RowExpander=function(A){Ext.apply(this,A);this.addEvents({beforeexpand:true,expand:true,beforecollapse:true,collapse:true});Ext.grid.RowExpander.superclass.constructor.call(this);if(this.tpl){if(typeof this.tpl=="string"){this.tpl=new Ext.Template(this.tpl)}this.tpl.compile()}this.state={};this.bodyContent={}};Ext.extend(Ext.grid.RowExpander,Ext.util.Observable,{header:"",width:20,sortable:false,fixed:true,menuDisabled:true,dataIndex:"",id:"expander",lazyRender:true,enableCaching:true,getRowClass:function(A,E,D,C){D.cols=D.cols-1;var B=this.bodyContent[A.id];if(!B&&!this.lazyRender){B=this.getBodyContent(A,E)}if(B){D.body=B}return this.state[A.id]?"x-grid3-row-expanded":"x-grid3-row-collapsed"},init:function(B){this.grid=B;var A=B.getView();A.getRowClass=this.getRowClass.createDelegate(this);A.enableRowBody=true;B.on("render",function(){A.mainBody.on("mousedown",this.onMouseDown,this)},this)},getBodyContent:function(A,B){if(!this.enableCaching){return this.tpl.apply(A.data)}var C=this.bodyContent[A.id];if(!C){C=this.tpl.apply(A.data);this.bodyContent[A.id]=C}return C},onMouseDown:function(B,A){if(A.className=="x-grid3-row-expander"){B.stopEvent();var C=B.getTarget(".x-grid3-row");this.toggleRow(C)}},renderer:function(B,C,A){C.cellAttr='rowspan="2"';if(A.data.description!=null&&A.data.description==""){return""}return'<div class="x-grid3-row-expander">&#160;</div>'},beforeExpand:function(B,A,C){if(this.fireEvent("beforeexpand",this,B,A,C)!==false){if(this.tpl&&this.lazyRender){A.innerHTML=this.getBodyContent(B,C)}return true}else{return false}},toggleRow:function(A){if(typeof A=="number"){A=this.grid.view.getRow(A)}this[Ext.fly(A).hasClass("x-grid3-row-collapsed")?"expandRow":"collapseRow"](A)},expandRow:function(C){if(typeof C=="number"){C=this.grid.view.getRow(C)}var B=this.grid.store.getAt(C.rowIndex);var A=Ext.DomQuery.selectNode("tr:nth(2) div.x-grid3-row-body",C);if(this.beforeExpand(B,A,C.rowIndex)){this.state[B.id]=true;Ext.fly(C).replaceClass("x-grid3-row-collapsed","x-grid3-row-expanded");this.fireEvent("expand",this,B,A,C.rowIndex)}},collapseRow:function(C){if(typeof C=="number"){C=this.grid.view.getRow(C)}var B=this.grid.store.getAt(C.rowIndex);var A=Ext.fly(C).child("tr:nth(1) div.x-grid3-row-body",true);if(this.fireEvent("beforecollapse",this,B,A,C.rowIndex)!==false){this.state[B.id]=false;Ext.fly(C).replaceClass("x-grid3-row-expanded","x-grid3-row-collapsed");this.fireEvent("collapse",this,B,A,C.rowIndex)}}});