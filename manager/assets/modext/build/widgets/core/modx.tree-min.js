Ext.namespace("MODx.tree");MODx.tree.Tree=function(C){C=C||{};if(C.url==null){return false}C.action=C.action||"getNodes";Ext.state.Manager.setProvider(new Ext.state.CookieProvider());Ext.applyIf(C,{baseParams:{}});if(C.action){C.baseParams.action=C.action}this.config=C;var B=new Ext.tree.TreeLoader({dataUrl:C.url,baseParams:C.baseParams});B.on("beforeload",function(E,F){B.dataUrl=this.config.url+"?action="+this.config.action+"&id="+F.attributes.id;if(F.attributes.type){B.dataUrl+="&type="+F.attributes.type}},this);Ext.applyIf(C,{animate:true,autoHeight:true,enableDrag:true,enableDrop:true,ddAppendOnly:false,rootVisible:true,loader:B,collapsible:true,hideBorders:true,bodyBorder:false,containerScroll:true,autoScroll:true,tools:[{id:"help",qtip:_("help"),handler:this.help,scope:this}]});if(C.remoteToolbar==true&&(C.tbar==undefined||C.tbar==null)){Ext.Ajax.request({url:C.url,params:{action:"getToolbar"},scope:this,success:function(E,F){E=Ext.decode(E.responseText);C.tbar=this._formatToolbar(E);this.setup(C)}})}else{var A=this.getToolbar();if(C.tbar&&C.useDefaultToolbar){A.push("-");for(var D=0;D<C.tbar.length;D++){A.push(C.tbar[D])}}else{if(C.tbar){A=C.tbar}}Ext.apply(C,{tbar:A});this.setup(C)}this.config=C};Ext.extend(MODx.tree.Tree,Ext.tree.TreePanel,{menu:null,options:{},setup:function(A){MODx.tree.Tree.superclass.constructor.call(this,A);this.cm=new Ext.menu.Menu(Ext.id(),{});this.on("contextmenu",this._showContextMenu,this);this.on("beforenodedrop",this._handleDrop,this);this.on("nodedragover",this._handleDrop,this);this.on("nodedrop",this._handleDrag,this);this.on("click",this._saveState,this);this.on("click",this._handleClick,this);this.root=new Ext.tree.AsyncTreeNode({text:A.root_name||"",draggable:false,id:A.root_id||"root"});this.setRootNode(this.root);this.treestate_id=Ext.id();this.on("load",this._initExpand,this,{single:true});this.root.expand();this._loadToolbar();if(A.el){this.render()}},_initExpand:function(){var A=Ext.state.Manager.get(this.treestate_id);if(A==undefined&&this.root){this.root.expand();if(this.root.firstChild&&this.config.expandFirst){this.root.firstChild.select();this.root.firstChild.expand()}}else{this.expandPath(A)}},addContextMenuItem:function(items){var a=items,l=a.length;for(var i=0;i<l;i++){var options=a[i];if(options=="-"){this.cm.add("-");continue}if(options.handler){var h=eval(options.handler)}else{var h=function(itm,e){var o=itm.options;var id=this.cm.activeNode.id.split("_");id=id[1];var w=Ext.get("modx_content");if(o.confirm){Ext.Msg.confirm("",o.confirm,function(e){if(e=="yes"){var a=Ext.urlEncode(o.params||{action:o.action});var s="index.php?id="+id+"&"+a;if(w==null){location.href=s}else{w.dom.src=s}}},this)}else{var a=Ext.urlEncode(o.params);var s="index.php?id="+id+"&"+a;if(w==null){location.href=s}else{w.dom.src=s}}}}this.cm.add({id:options.id,text:options.text,scope:this,options:options,handler:h})}},hasNode:function(A,B){return(A.findChild("id",B.id))||(A.leaf===true&&A.parentNode.findChild("id",B.id))},refresh:function(D,C,B){var A=Ext.state.Manager.get(this.treestate_id);this.root.reload();A==undefined?this.root.expand(null,null):this.expandPath(A,null);if(D){C=C||this;B=B||[];this.root.on("load",function(){Ext.callback(D,C,B)},C)}return true},remove:function(F,D,A){var C=this.cm.activeNode;var G=this._extractId(C.id,D,A);var E={action:"remove"};var B=this.config.primaryKey||"id";E[B]=G;MODx.msg.confirm({title:_("warning"),text:_(F),connector:this.config.url,params:E,scope:this,success:this.refresh})},_extractId:function(C,B,A){B=B||false;A=A||false;if(B!=false){C=node.id.substr(B)}if(A!=false){C=node.id.split("_");C=C[A]}return C},expand:function(){if(this.root){this.root.expand();this.root.expandChildNodes()}},collapse:function(){if(this.root){this.root.collapseChildNodes();this.root.collapse()}},_saveState:function(A){Ext.state.Manager.set(this.treestate_id,A.getPath())},_handleClick:function(B,A){A.preventDefault();A.stopEvent();if(B.attributes.href&&B.attributes.href!=""){Ext.get("modx_content").dom.src=B.attributes.href}},_handleDrag:function(B){Ext.Msg.show({title:_("please_wait"),msg:_("saving"),width:240,progress:true,closable:false});_resetProgress();for(var A=1;A<20;A++){setTimeout("MODx.util.Progress.time("+A+","+MODx.util.Progress.id+")",A*1000)}function D(I){var F={};var G=I.childNodes;var E=G.length;for(var H=0;H<E;H++){F[G[H].id]=D(G[H])}return F}var C=Ext.encode(D(B.tree.root));Ext.Ajax.request({url:this.config.url,scope:this,params:{data:encodeURIComponent(C),action:"sort"},success:function(E){_resetProgress();Ext.Msg.hide();var F=Ext.decode(E.responseText);if(!F.success){this.refresh();MODx.form.Handler.errorJSON(F);return false}}})},_handleDrop:function(){},_showContextMenu:function(B,C){B.select();this.cm.activeNode=B;var A=B.id.split("_");this.cm.removeAll();if(B.attributes.menu){this.addContextMenuItem(B.attributes.menu);this.cm.show(B.ui.getEl(),"t?")}},_guid:function(A){return A+(new Date().getTime())},redirect:function(B){var A=Ext.get("modx_content");if(A!=null){A.dom.src=B}else{location.href=B}},_loadToolbar:function(){},refreshNode:function(C,A){var B=this.getNodeById(C);if(B){A?B.reload():B.parentNode.reload()}},refreshActiveNode:function(){this.cm.activeNode.reload();this.cm.activeNode.expand()},refreshParentNode:function(){this.cm.activeNode.parentNode.reload()},removeNode:function(B){var A=this.getNodeById(B);if(A){A.remove()}},removeActiveNode:function(){this.cm.activeNode.remove()},getToolbar:function(){var A=MODx.config.template_url+"images/icons/";return[{icon:A+"arrow_down.png",cls:"x-btn-icon",scope:this,tooltip:{text:_("tree_expand")},handler:this.expand},{icon:A+"arrow_up.png",cls:"x-btn-icon",scope:this,tooltip:{text:_("tree_collapse")},handler:this.collapse},"-",{icon:A+"sort.png",cls:"x-btn-icon",scope:this,tooltip:{text:_("tree_refresh")},handler:this.refresh}]},_formatToolbar:function(a){var l=a.length;for(var i=0;i<l;i++){if(a[i].handler){a[i].handler=eval(a[i].handler)}Ext.applyIf(a[i],{scope:this,cls:"x-btn-icon"})}return a},help:function(){MODx.msg.alert(_("help"),_("help_not_yet"))}});Ext.reg("modx-tree",MODx.tree.Tree);