MODx.tree.DGUG=function(A){A=A||{};Ext.applyIf(A,{root_id:"0",root_name:_("document_groups"),enableDrag:false,enableDrop:true,ddAppendOnly:true,action:"getPairingNodes"});MODx.tree.DGUG.superclass.constructor.call(this,A);this.addContextMenuItem({id:"new_documentgroup",text:_("create_document_group"),handler:this.showCreate,scope:this})};Ext.extend(MODx.tree.DGUG,MODx.tree.Tree,{forms:{},dialogs:{},stores:{},removePairing:function(B,C){var E=this.cm.activeNode;var A=E.id.substr(2).split("_");A=A[1];var D=E.parentNode.id.substr(2).split("_");D=D[1];MODx.msg.confirm({text:_("confirm_delete_user_group_document_group"),connector:MODx.config.connectors_url+"security/documentgroup.php",params:{action:"removePairing",ug_id:A,dg_id:D},scope:this,success:function(F,G){this.refresh()}})},remove:function(A,B){var D=this.cm.activeNode;var C=D.id.substr(2).split("_");C=C[1];MODx.msg.confirm({text:_("confirm_delete_document_group"),connector:MODx.config.connectors_url+"security/documentgroup.php",params:{action:"remove",id:C},scope:this,success:function(E,F){this.refresh();this.dgtree.refresh()}})},create:function(A,B){var D=this.cm.activeNode.id.substr(2);D=D[1];var C=new MODx.window.CreateDocumentGroup({title:_("create_document_group"),success:function(){this.refresh();this.dgtree.refresh()},scope:this});C.show(B.target);this.dialogs.create=C},isUGCopy:function(B,C){var A=B.target.attributes;if(B.target.findChild("id",C.attributes.id)!=null){return false}return C.attributes.type=="usergroup"&&C.getOwnerTree().getEl().id==this.ugtree.getEl().id&&((B.point=="append"&&A.type=="documentgroup")||A.leaf===false)},createDGUG:function(D,C){var B=this.getNodeById(D.attributes.cmpId);var A=new Ext.tree.TreeNode({text:C,cmpId:B.id,leaf:true,allowDelete:true,allowEdit:true,id:this._guid("o-")});B.childNodes[2].appendChild(A);B.childNodes[2].expand(false,false);return A},_showContextMenu:function(D,E){D.select();var A=this.cm;var B=D.id.split("_");A.removeAll();A.add({id:"create_document_group",text:_("create_document_group"),scope:this,handler:this.create});var C=B[1];switch(C){case"ug":A.add("-",{id:"remove_pairing",text:_("delete_user_group_document_group"),scope:this,handler:this.removePairing});break;case"dg":A.add("-",{id:"remove_group",text:_("delete_document_group"),scope:this,handler:this.remove});break}A.show(D.ui.getEl(),"t?");A.activeNode=D},_handleDrop:function(A){var C=A.dropNode;if(this.isUGCopy(A,C)){var B=new Ext.tree.TreeNode(Ext.apply({leaf:true,allowDelete:true,expanded:true},C.attributes));B.loader=undefined;if(A.target.attributes.options){A.target=this.createDGUG(A.target,B.text)}A.dropNode=B;return true}return false},_handleDrag:function(B){Ext.Msg.show({title:_("please_wait"),msg:_("saving"),width:240,progress:true,closable:false});_resetProgress();for(var A=1;A<20;A++){setTimeout("MODx.util.Progress.time("+A+","+MODx.util.Progress.id+")",A*1000)}function D(I){var F={};var G=I.childNodes;var E=G.length;for(var H=0;H<E;H++){F[G[H].id]=D(G[H])}return F}var C=Ext.encode(D(B.tree.root));Ext.Ajax.request({url:this.config.url,scope:this,params:{data:encodeURIComponent(C),action:"updatePairing"},callback:function(H,E,G){_resetProgress();Ext.Msg.hide();var F=Ext.decode(G.responseText);if(!F.success){MODx.form.Handler.errorJSON(F);this.refresh();return false}}})}});Ext.reg("tree-dgug",MODx.tree.DGUG);